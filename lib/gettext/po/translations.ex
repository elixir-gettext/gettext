defmodule Gettext.PO.Translations do
  @moduledoc false

  alias Expo.Message

  defmacrop is_translation(module) do
    quote do
      unquote(module) in [Message.Singular, Message.Plural]
    end
  end

  @doc """
  Tells whether a translation was manually entered or generated by Gettext.

  As of now, a translation is considered autogenerated if it has the "elixir-autogen" flag.

  ## Examples

      iex> t = %Expo.Message.Singular{msgid: ["foo"], flags: [["elixir-autogen"]]}
      iex> Gettext.PO.Translations.autogenerated?(t)
      true

      iex> t = %Expo.Message.Singular{msgid: ["foo"]}
      iex> Gettext.PO.Translations.autogenerated?(t)
      false

  """
  @spec autogenerated?(translation :: Message.t()) :: boolean
  def autogenerated?(translation) do
    Message.has_flag?(translation, "elixir-autogen")
  end

  @doc """
  Tells whether a translation is protected from purging.

  A translation that is protected from purging will never be removed by Gettext.
  Which translations are proteced can be configured using Mix.

  ## Example

      iex> protected_pattern = ~r{^web/static/}
      iex> t = %Expo.Message.Singular{msgid: ["Hello world!"], references: [{"web/static/js/app.js", 42}]}
      iex> Gettext.PO.Translations.protected?(t, protected_pattern)
      true

  """
  @spec protected?(translation :: Message.t(), protected_pattern :: Regex.t()) :: boolean
  def protected?(translation, protected_pattern)

  def protected?(_t, nil), do: false

  def protected?(%module{references: []}, _pattern) when is_translation(module), do: false

  def protected?(%module{references: refs}, pattern) when is_translation(module),
    do: Enum.any?(refs, fn {path, _} -> Regex.match?(pattern, path) end)
end
